<%- include('../partials/html.ejs') %>

<head>
    <%- include("../partials/title-meta.ejs", {title: "Gallery"}) %>

    <link rel="stylesheet" href="/backend/libs/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/backend/libs/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="/backend/libs/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="/backend/libs/datatables.net-select-bs5/css/select.bootstrap5.min.css">

    <style>
        .gallery-card {
            height: 250px;
            margin-bottom: 20px;
        }
        .gallery-img {
            height: 180px;
            object-fit: cover;
        }
        .masonry-gallery {
            column-count: 3;
            column-gap: 15px;
        }
        @media (max-width: 992px) {
            .masonry-gallery {
                column-count: 2;
            }
        }
        @media (max-width: 576px) {
            .masonry-gallery {
                column-count: 1;
            }
        }
        .gallery-item {
            break-inside: avoid;
            margin-bottom: 15px;
        }
    </style>

    <%- include('../partials/head-css.ejs') %>
</head>

<body>
    <!-- Begin page -->
    <div class="wrapper">

        <%- include('../partials/menu.ejs') %>

        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->

        <div class="page-content">

            <div class="page-container">

                <%- include("../partials/page-title.ejs", {subtitle:"Media", title:"Gallery"}) %>

                <%- include("../partials/validation-message.ejs") %>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-xl-9">
                                        <h5 class="card-title">Gallery Images</h5>
                                        <p class="card-subtitle">
                                            Browse and manage all gallery images in one place.
                                        </p>
                                    </div>
                                    <div class="col-xl-3">
                                        <div class="card-body">
                                            <button class="btn btn-primary w-100" id="btn-add-image">
                                                <i class="ti ti-plus me-2 align-middle"></i> Add Image
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <% if (galleryItems && galleryItems.length > 0) { %>
                                    <div class="masonry-gallery">
                                        <% galleryItems.forEach(function(item) { %>
                                            <div class="gallery-item">
                                                <div class="card">
                                                    <img src="<%= item.image %>" class="card-img-top gallery-img" alt="<%= item.subtitle %>">
                                                    <div class="card-body">
                                                        <h5 class="card-title"><%= item.subtitle %></h5>
                                                        <p class="card-text text-muted small">Added on: <%= new Date(item.createdAt).toLocaleDateString() %></p>
                                                        <button type="button" class="btn btn-danger btn-sm btn-gallery-delete" data-gallery-id="<%= item.id %>">
                                                            <i class="mdi mdi-delete"></i> Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        <% }); %>
                                    </div>
                                <% } else { %>
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i class="ti ti-photo-off display-4 text-muted"></i>
                                        </div>
                                        <h4>No images in gallery</h4>
                                        <p class="text-muted">Click the 'Add Image' button to upload your first image.</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div> <!-- end row -->

                <!-- Add New Image MODAL -->
                <div class="modal fade" id="gallery-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/settings/gallery/add" id="gallery-form" class="needs-validation" novalidate method="POST" enctype="multipart/form-data">
                                <div class="modal-header p-3 border-bottom-0">
                                    <h5 class="modal-title" id="modal-title">
                                        Add New Image
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body px-3 pb-3 pt-0">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label for="subtitle" class="form-label">Image Title/Subtitle</label>
                                                <input 
                                                  type="text" 
                                                  class="form-control" 
                                                  id="subtitle" 
                                                  name="subtitle" 
                                                  placeholder="Enter image title"
                                                  required
                                                >
                                                <div class="invalid-feedback">Please provide a title for this image</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label for="image" class="form-label">Upload Image</label>
                                                <input 
                                                  type="file" 
                                                  class="form-control" 
                                                  id="image" 
                                                  name="image" 
                                                  accept="image/*"
                                                  required
                                                >
                                                <div class="invalid-feedback">Please select an image to upload</div>
                                                <div class="form-text mt-1">
                                                    Max file size: 5MB. Supported formats: JPG, PNG, GIF.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div id="image-preview-container" class="mt-3 d-none">
                                                <h6 class="mb-2">Image Preview</h6>
                                                <img id="image-preview" src="#" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                                            </div>
                                        </div>
                                    </div>
                                
                                    <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                                        <button type="button" class="btn btn-light ms-auto" data-bs-dismiss="modal">
                                            Close
                                        </button>
                                    
                                        <button type="submit" class="btn btn-primary" id="btn-save-image">
                                            Upload
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- end modal-->

                <!-- Delete Image Modal -->
                <div class="modal fade" id="delete-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/settings/gallery/delete" id="delete-form" class="needs-validation" novalidate method="POST">
                                <div class="modal-header p-3 border-bottom-0">
                                    <h5 class="modal-title" id="modal-title">
                                        Delete Image
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body px-3 pb-3 pt-0">
                                    <div class="row">
                                        <input type="hidden" name="id" id="delete-gallery-id">
                                        <div class="col-12 mb-3">
                                            <div class="alert alert-danger" role="alert">
                                                <div class="d-flex align-items-center">
                                                    <i class="ti ti-alert-triangle me-2 fs-3"></i>
                                                    <div>
                                                        <h5 class="alert-heading mb-1">Warning: Deletion Confirmation</h5>
                                                        <p class="mb-0">Are you sure you want to delete this image? This action cannot be undone.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <button type="button" class="btn btn-light me-auto" data-bs-dismiss="modal">
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn btn-danger" id="btn-delete-confirm">
                                            <i class="ti ti-trash me-1"></i> Yes, Delete
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div> <!-- container -->

            <%- include('../partials/footer.ejs') %>

        </div>

        <!-- ============================================================== -->
        <!-- End Page content -->
        <!-- ============================================================== -->

    </div>
    <!-- END wrapper -->

    <%- include('../partials/customizer.ejs') %>

    <%- include('../partials/footer-scripts.ejs') %>

    <!-- Custom JS for gallery -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add Image button click handler
            document.getElementById('btn-add-image').addEventListener('click', function() {
                const galleryModal = new bootstrap.Modal(document.getElementById('gallery-modal'));
                galleryModal.show();
            });

            // Image preview on file selection
            document.getElementById('image').addEventListener('change', function(e) {
                const previewContainer = document.getElementById('image-preview-container');
                const preview = document.getElementById('image-preview');
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        previewContainer.classList.remove('d-none');
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                } else {
                    preview.src = '';
                    previewContainer.classList.add('d-none');
                }
            });

            // Delete button click handlers
            document.querySelectorAll('.btn-gallery-delete').forEach(function(button) {
                button.addEventListener('click', function() {
                    const galleryId = this.getAttribute('data-gallery-id');
                    document.getElementById('delete-gallery-id').value = galleryId;
                    
                    const deleteModal = new bootstrap.Modal(document.getElementById('delete-modal'));
                    deleteModal.show();
                });
            });

            // Form validation
            const forms = document.querySelectorAll('.needs-validation');
            
            Array.from(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    form.classList.add('was-validated');
                }, false);
            });
        });
    </script>

</body>

</html>