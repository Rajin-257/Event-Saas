<%- include('../partials/html.ejs') %>

<head>
    <%- include("../partials/title-meta.ejs", {title: "Datatables"}) %>

    <link rel="stylesheet" href="/admin/libs/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/admin/libs/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="/admin/libs/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="/admin/libs/datatables.net-select-bs5/css/select.bootstrap5.min.css">

    <%- include('../partials/head-css.ejs') %>
</head>

<body>
    <!-- Begin page -->
    <div class="wrapper">

        <%- include('../partials/menu.ejs') %>

            <!-- Start Page Content -->
    <div class="page-content">
        <div class="page-container">
            <%- include("../partials/page-title.ejs", {subtitle: "Users", title: "User Management"}) %>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <%- include('../partials/alert.ejs') %>
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">User List</h5>
                                <p class="card-subtitle">
                                    Comprehensive list of registered users with key details
                                </p>
                            </div>
                            <button type="button" class="btn btn-success waves-effect waves-light" id="userCreate">
                                <span class="btn-label"><i class="mdi mdi-account"></i></span>Add User
                            </button>
                        </div>
                        
                        <div class="card-body pt-2">
                            <table id="users-datatable" class="table table-bordered table-hover dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Photo</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Roles</th>
                                        <th>Created At</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (data && data.users) { %>
                                        <% data.users.forEach(user => { %>
                                        <tr>
                                            <td><%= user.id %></td>
                                            <td>
                                                <% if (user.profile_image) { %>
                                                    <img src="<%- APP_URL + user.profile_image %>" 
                                                         width="32" 
                                                         class="rounded-circle me-lg-2 d-flex" 
                                                         alt="user-image">
                                                <% } else { %>
                                                    N/A
                                                <% } %>
                                            </td>
                                            <td><%= user.first_name || 'N/A' %> <%= user.last_name || 'N/A' %></td>
                                            <td><%= user.email || 'N/A' %></td>
                                            <td><%= user.phone || 'N/A' %></td>
                                            <td>
                                                <span class="badge 
                                                    <%= user.status === 'active' ? 'bg-success' : 
                                                        user.status === 'inactive' ? 'bg-danger' : 'bg-secondary' %>">
                                                    <%= user.status || 'Unknown' %>
                                                </span>
                                            </td>
                                            <td>
                                                <% if (user.Roles && user.Roles.length > 0) { %>
                                                    <% user.Roles.forEach(role => { %>
                                                        <span class="badge bg-info me-1"><%= role.name %></span>
                                                    <% }); %>
                                                <% } else { %>
                                                    <span class="badge bg-secondary">No Roles</span>
                                                <% } %>
                                            </td>
                                            <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A' %></td>
                                            <td><%= user.last_login ? new Date(user.last_login).toLocaleDateString() : 'N/A' %></td>
                                            <td>
                                                <div class="button-list">
                                                    <button id="update-modal" data-user-id="<%= user.id %>" class="btn btn-icon waves-effect waves-light btn-primary"> <i class="mdi mdi-pencil"></i> </button>
                                                    <button id="user-del" data-user-id="<%= user.id %>" class="btn btn-icon waves-effect waves-light btn-danger">  <i class="mdi mdi-delete"></i> </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center">No users found</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> <!-- end row -->

            <!-- Add New Event MODAL -->
            <div class="modal fade" id="user-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/admin/api/users" id="user-form"  method="POST">
                            <div class="modal-header p-3 border-bottom-0">
                                <h5 class="modal-title" id="modal-title">
                                    Add New User
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body px-3 pb-3 pt-0">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="first_name" class="form-label">First Name</label>
                                            <input 
                                              type="text" 
                                              class="form-control" 
                                              id="first_name" 
                                              name="first_name" 
                                              placeholder="Enter your First name"
                                              required
                                            >
                                            <div class="invalid-feedback">Please provide a valid name</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="last_name" class="form-label">Last Name</label>
                                            <input 
                                              type="text" 
                                              class="form-control" 
                                              id="name" 
                                              name="last_name" 
                                              placeholder="Enter your full Last name"
                                              required
                                            >
                                            <div class="invalid-feedback">Please provide a valid name</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input 
                                              type="email" 
                                              class="form-control" 
                                              id="email" 
                                              name="email" 
                                              placeholder="Enter your email"
                                              required
                                            >
                                            <div class="invalid-feedback">Please provide a valid Email</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="user-mobile" class="control-label form-label">Mobile No.</label>
                                            <input 
                                                class="form-control" 
                                                placeholder="Insert Mobile Number" 
                                                type="tel" 
                                                id="user-mobile" 
                                                name="phone" 
                                                required 
                                            />
                                            <div class="invalid-feedback">Please provide a valid Mobile Number</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="input-group">
                                          <input 
                                            type="hidden" 
                                            class="form-control" 
                                            id="password" 
                                            name="password" 
                                            placeholder="Create a password"
                                            required
                                          >
                                        </div>
                                    </div>
                                    <div class="col-12">
                                     <label for="confirmPassword" class="form-label text-danger" >Password Generating autometically. first word from the email address (before gmail.com) capital.Then last Four Digits of number.  </label>
                                     <input 
                                       type="hidden" 
                                       class="form-control" 
                                       id="confirmPassword" 
                                       name="confirmPassword" 
                                       placeholder="Confirm your password"
                                       required
                                     >
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="is_verified" class="control-label form-label">Verify</label>
                                            <select 
                                                class="form-select" 
                                                id="is_verified" 
                                                name="is_verified" 
                                                required
                                            >
                                                <option value="0">Choose or Default</option>
                                                <option value="0">false</option>
                                                <option value="1">True</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="user-role" class="control-label form-label">Role</label>
                                            <select 
                                                class="form-select" 
                                                id="user-role" 
                                                name="roles" 
                                                required
                                            >
                                                <option value="">Choose Role</option>
                                                <option value="admin">Admin</option>
                                                <option value="user">User</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a valid role</div>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <button type="button" class="btn btn-danger" id="btn-delete-event">
                                        Delete
                                    </button>
                                
                                    <button type="button" class="btn btn-light ms-auto" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                
                                    <button type="submit" class="btn btn-primary" id="btn-save-event">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- end modal-->

            <!-- Edit Modal -->
             <div class="modal fade" id="update-user-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/admin/api/usersUpdate" id="user-form" class="needs-validation" novalidate method="POST">
                            <div class="modal-header p-3 border-bottom-0">
                                <h5 class="modal-title" id="modal-title">
                                    Add New User
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body px-3 pb-3 pt-0">
                                <div class="row">
                                    <div class="col-12">
                                        <input type="hidden" name="id" id="update-userId">
                                        <div class="mb-3">
                                            <label for="user-status" class="control-label form-label">Status</label>
                                            <input type="hidden" name="userId" >
                                            <select 
                                                class="form-select" 
                                                id="user-status" 
                                                name="status" 
                                                required
                                            >
                                                <option value="">Choose Status</option>
                                                <option value="active">Activate</option>
                                                <option value="inactive">Deactivate</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="user-role" class="control-label form-label">Role</label>
                                            <input type="hidden" name="userId" >
                                            <select 
                                                class="form-select" 
                                                id="user-role" 
                                                name="role"
                                            >
                                                <option value="">Choose Role</option>
                                                <option value="admin">Admin</option>
                                                <option value="user">User</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                
                                    <button type="button" class="btn btn-light ms-auto" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                
                                    <button type="submit" class="btn btn-primary" id="btn-save-event">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="delete-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/admin//api/delUsers" id="user-del-form"  method="POST">
                            <div class="modal-header p-3 border-bottom-0">
                                <h5 class="modal-title" id="modal-title">
                                    Delete User
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body px-3 pb-3 pt-0">
                                <div class="row">
                                    <!-- Delete warning UI -->
                                     <input type="hidden" name="id">
                                    <div class="col-12 mb-3">
                                        <div class="alert alert-danger" role="alert">
                                            <div class="d-flex align-items-center">
                                                <i class="ti ti-alert-triangle me-2 fs-3"></i>
                                                <div>
                                                    <h5 class="alert-heading mb-1">Warning: Deletion Confirmation</h5>
                                                    <p class="mb-0">Are you sure you want to delete this item? This action cannot be undone.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <button type="button" class="btn btn-light me-auto" data-bs-dismiss="modal">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-danger" id="btn-delete-confirm">
                                        <i class="ti ti-trash me-1"></i> Yes, Delete
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div> <!-- container -->

        <%- include('../partials/footer.ejs') %>
    </div>
    <!-- End Page content -->
</div>
<!-- END wrapper -->

<%- include('../partials/customizer.ejs') %>
<%- include('../partials/footer-scripts.ejs') %>

<!-- Datatable plugin js -->
<script src="/admin/libs/datatables.net/js/dataTables.min.js"></script>
<script src="/admin/libs/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="/admin/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="/admin/libs/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
<script src="/admin/libs/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="/admin/libs/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js"></script>
<script src="/admin/libs/datatables.net-buttons/js/buttons.html5.min.js"></script>
<script src="/admin/libs/datatables.net-buttons/js/buttons.print.min.js"></script>

<!-- Custom JS for User Table -->
<script>
// Add this script at the end of your Custom JS for User Table section
$(document).ready(function() {
    $(document).ready(function() {
    // Initialize DataTable
    $('#users-datatable').DataTable({
        responsive: true,
        lengthChange: true,
        language: {
            paginate: {
                previous: '<i class="mdi mdi-chevron-left">',
                next: '<i class="mdi mdi-chevron-right">'
            }
        }
    });
    
    // Add Event Listener for the Add User button
    $('#userCreate').on('click', function() {
        $('#user-modal').modal('show');
    });

    // Replace your existing event listener for update-modal
    $(document).on('click', '#update-modal', function() {
        const userId = $(this).data('user-id');
        $('#update-user-modal input[name="id"]').val(userId);
        $('#update-user-modal').modal('show');
    });
    $(document).on('click','#user-del',function(){
        const userId = $(this).data('user-id');
        $('#delete-modal input[name="id"]').val(userId);
        $('#delete-modal').modal('show');
    })

    // Real-time form validation
    const form = document.getElementById('user-form');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const mobileInput = document.getElementById('user-mobile');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const roleSelect = document.getElementById('user-role');

    // Real-time validation for name
    nameInput.addEventListener('input', function() {
        if (this.value.trim() === '') {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });

    // Real-time validation for email and auto-generate password
    emailInput.addEventListener('input', function() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(this.value)) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            
            // Auto-generate password when both email and mobile are valid
            generatePassword();
        }
    });

    // Real-time validation for mobile
    mobileInput.addEventListener('input', function() {
        const mobileRegex = /^\d{10,15}$/;
        if (!mobileRegex.test(this.value.replace(/\D/g, ''))) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            
            // Auto-generate password when both email and mobile are valid
            generatePassword();
        }
    });

    // Real-time validation for role
    roleSelect.addEventListener('change', function() {
        if (this.value === '') {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });

    // Function to generate password
    function generatePassword() {
        if (emailInput.value && mobileInput.value && 
            !emailInput.classList.contains('is-invalid') && 
            !mobileInput.classList.contains('is-invalid')) {
            
            // Get username part from email (before @)
            const emailPart = emailInput.value.split('@')[0];
            // Capitalize first letter
            const capitalizedEmailPart = emailPart.charAt(0).toUpperCase() + emailPart.slice(1);
            
            // Get last 4 digits of phone number
            const cleanMobile = mobileInput.value.replace(/\D/g, '');
            const lastFourDigits = cleanMobile.slice(-4);
            
            // Combine for password
            const generatedPassword = capitalizedEmailPart +'@'+ lastFourDigits;
            
            // Set password fields
            passwordInput.value = generatedPassword;
            confirmPasswordInput.value = generatedPassword;
            
            // Update the password hint text
            document.querySelector('label[for="confirmPassword"]').innerHTML = 
                'Auto-generated password: <strong>' + generatedPassword + '</strong> (first part of email capitalized + last 4 digits of phone)';
        }
    }

    // Form submission validation
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        form.classList.add('was-validated');
    });
});
});


</script>

</body>

</html>