<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/title-meta') %>
    <title>User Details | Admin Dashboard</title>
    <%- include('../partials/head-css') %>
</head>

<body>
    <!-- Begin page -->
    <div class="wrapper">
        <%- include('../partials/menu') %>
        
        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <div class="page-content">
            <div class="page-container">
                <!-- Page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="/admin/users">User Management</a></li>
                                    <li class="breadcrumb-item active">User Details</li>
                                </ol>
                            </div>
                            <h4 class="page-title">User Details</h4>
                        </div>
                    </div>
                </div>

                <!-- Flash messages -->
                <% if(typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= success_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>
                
                <% if(typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>
                
                <div class="row">
                    <!-- User Info Card -->
                    <div class="col-xl-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="text-center">
                                    <% if (userbyadmin.profileImage) { %>
                                    <img src="<%= userbyadmin.profileImage %>" class="rounded-circle avatar-xl mb-3" alt="profile-image">
                                    <% } else { %>
                                    <div class="avatar-xl mx-auto mb-3">
                                        <div class="avatar-title bg-primary-subtle text-primary font-24 rounded-circle">
                                            <%= userbyadmin.name.charAt(0).toUpperCase() %>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <h4 class="mb-1"><%= userbyadmin.name %></h4>
                                    <p class="text-muted">
                                        <% let badgeClass = "badge bg-info" %>
                                        <% if (userbyadmin.role === 'super_admin') { badgeClass = "badge bg-danger" } %>
                                        <% if (userbyadmin.role === 'organizer') { badgeClass = "badge bg-warning" } %>
                                        <span class="<%= badgeClass %>"><%= userbyadmin.role %></span>
                                    </p>
                                </div>

                                <div class="mt-3 pt-2 border-top">
                                    <h5 class="mb-3">Contact Information</h5>
                                    <div class="table-responsive">
                                        <table class="table table-borderless mb-0 text-start">
                                            <tbody>
                                                <tr>
                                                    <th scope="row" width="35%">Email:</th>
                                                    <td><a href="mailto:<%= userbyadmin.email %>"><%= userbyadmin.email %></a></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Phone:</th>
                                                    <td><%= userbyadmin.phone || 'Not provided' %></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Status:</th>
                                                    <td>
                                                        <% let statusBadge = "badge bg-success" %>
                                                        <% if (userbyadmin.status === 'inactive') { statusBadge = "badge bg-warning" } %>
                                                        <% if (userbyadmin.status === 'blocked') { statusBadge = "badge bg-danger" } %>
                                                        <span class="<%= statusBadge %>"><%= userbyadmin.status %></span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Verified:</th>
                                                    <td>
                                                        <% if (userbyadmin.verified) { %>
                                                        <span class="badge bg-success"><i class="ri-check-line"></i> Yes</span>
                                                        <% } else { %>
                                                        <span class="badge bg-warning"><i class="ri-close-line"></i> No</span>
                                                        <% } %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Wallet Balance:</th>
                                                    <td><span class="fw-semibold">$<%= parseFloat(userbyadmin.walletBalance).toFixed(2) %></span></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Referral Code:</th>
                                                    <td><%= userbyadmin.referralCode %></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Joined Date:</th>
                                                    <td><%= new Date(userbyadmin.createdAt).toLocaleDateString() %></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Last Login:</th>
                                                    <td><%= userbyadmin.lastLogin ? new Date(userbyadmin.lastLogin).toLocaleString() : 'Never' %></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tickets and Referrals -->
                    <div class="col-xl-8">
                        <!-- Tabs Nav -->
                        <ul class="nav nav-tabs nav-bordered mb-3" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tickets-tab" data-bs-toggle="tab" href="#tickets" role="tab" aria-controls="tickets" aria-selected="true">
                                    User Tickets <span class="badge bg-danger rounded-pill ms-1"><%= tickets.length %></span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="referrals-tab" data-bs-toggle="tab" href="#referrals" role="tab" aria-controls="referrals" aria-selected="false">
                                    Referrals <span class="badge bg-info rounded-pill ms-1"><%= referrals.length %></span>
                                </a>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- Tickets Tab -->
                            <div class="tab-pane show active" id="tickets" role="tabpanel" aria-labelledby="tickets-tab">
                                <div class="card">
                                    <div class="card-body">
                                        <% if (tickets.length > 0) { %>
                                            <div class="table-responsive">
                                                <table class="table table-hover table-centered mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Event</th>
                                                            <th>Type</th>
                                                            <th>Status</th>
                                                            <th>Purchased</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% tickets.forEach(ticket => { %>
                                                        <tr>
                                                            <td><%= ticket.id.substring(0, 8) %>...</td>
                                                            <td><%= ticket.eventId %></td>
                                                            <td><%= ticket.type %></td>
                                                            <td>
                                                                <% let ticketStatusBadge = "badge bg-success" %>
                                                                <% if (ticket.status === 'cancelled') { ticketStatusBadge = "badge bg-danger" } %>
                                                                <% if (ticket.status === 'pending') { ticketStatusBadge = "badge bg-warning" } %>
                                                                <span class="<%= ticketStatusBadge %>"><%= ticket.status %></span>
                                                            </td>
                                                            <td><%= new Date(ticket.createdAt).toLocaleDateString() %></td>
                                                            <td>
                                                                <a href="/admin/tickets/<%= ticket.id %>" class="btn btn-sm btn-info">View</a>
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        <% } else { %>
                                            <div class="text-center p-4">
                                                <div class="avatar-md mx-auto mb-3">
                                                    <div class="avatar-title bg-light text-primary rounded-circle">
                                                        <i class="ri-ticket-line font-24"></i>
                                                    </div>
                                                </div>
                                                <h5>No Tickets Found</h5>
                                                <p class="text-muted">This user hasn't purchased any tickets yet.</p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Referrals Tab -->
                            <div class="tab-pane" id="referrals" role="tabpanel" aria-labelledby="referrals-tab">
                                <div class="card">
                                    <div class="card-body">
                                        <% if (referrals.length > 0) { %>
                                            <div class="table-responsive">
                                                <table class="table table-hover table-centered mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Referred User</th>
                                                            <th>Status</th>
                                                            <th>Reward</th>
                                                            <th>Date</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% referrals.forEach(referral => { %>
                                                        <tr>
                                                            <td><%= referral.id.substring(0, 8) %>...</td>
                                                            <td><%= referral.referredId %></td>
                                                            <td>
                                                                <% let refStatusBadge = "badge bg-success" %>
                                                                <% if (referral.status === 'pending') { refStatusBadge = "badge bg-warning" } %>
                                                                <span class="<%= refStatusBadge %>"><%= referral.status %></span>
                                                            </td>
                                                            <td>$<%= parseFloat(referral.rewardAmount).toFixed(2) %></td>
                                                            <td><%= new Date(referral.createdAt).toLocaleDateString() %></td>
                                                            <td>
                                                                <a href="/admin/users/<%= referral.referredId %>" class="btn btn-sm btn-info">View User</a>
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        <% } else { %>
                                            <div class="text-center p-4">
                                                <div class="avatar-md mx-auto mb-3">
                                                    <div class="avatar-title bg-light text-primary rounded-circle">
                                                        <i class="ri-user-add-line font-24"></i>
                                                    </div>
                                                </div>
                                                <h5>No Referrals Found</h5>
                                                <p class="text-muted">This user hasn't referred anyone yet.</p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- container -->
            <%- include('../partials/footer') %>
        </div>
        <!-- ============================================================== -->
        <!-- End Page content -->
        <!-- ============================================================== -->
    </div>
    <!-- END wrapper -->

    <%- include('../partials/customizer') %>
    <%- include('../partials/footer-scripts') %>
</body>
</html>