<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Event Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-light">
  <%- include('../partials/header') %>
  
  <div class="container-fluid">
    <div class="row">
      <%- include('../partials/sidebar') %>
      
      <div class="col-lg-10 col-md-12 px-4 py-4">
        <!-- Alert messages -->
        <% if(success_msg != '') { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>
        
        <% if(error_msg != '') { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>
        
        <nav aria-label="breadcrumb" class="mb-4">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/payments">Payments</a></li>
            <li class="breadcrumb-item active" aria-current="page">Payment Details</li>
          </ol>
        </nav>
        
        <div class="row">
          <div class="col-lg-8">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Payment Details</h5>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Payment ID:</div>
                  <div class="col-md-8 fw-bold">#<%= payment.id %></div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Event:</div>
                  <div class="col-md-8">
                    <a href="/events/<%= payment.Ticket.Event.id %>">
                      <%= payment.Ticket.Event.title %>
                    </a>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Ticket Code:</div>
                  <div class="col-md-8">
                    <a href="/tickets/view/<%= payment.Ticket.ticket_code %>">
                      <%= payment.Ticket.ticket_code %>
                    </a>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Payment Method:</div>
                  <div class="col-md-8"><%= payment.PaymentMethod.name %></div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Amount:</div>
                  <div class="col-md-8 fw-bold fs-5"><%= formatCurrency(payment.amount) %></div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Status:</div>
                  <div class="col-md-8">
                    <% if (payment.status === 'completed') { %>
                      <span class="badge bg-success">Completed</span>
                    <% } else if (payment.status === 'pending') { %>
                      <span class="badge bg-warning text-dark">Pending</span>
                    <% } else if (payment.status === 'failed') { %>
                      <span class="badge bg-danger">Failed</span>
                    <% } else { %>
                      <span class="badge bg-secondary">Refunded</span>
                    <% } %>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Payment Date:</div>
                  <div class="col-md-8">
                    <%= payment.payment_date ? formatDateTime(payment.payment_date) : 'Not completed' %>
                  </div>
                </div>
                
                <% if (payment.transaction_id) { %>
                  <div class="row mb-3">
                    <div class="col-md-4 text-muted">Transaction ID:</div>
                    <div class="col-md-8 font-monospace"><%= payment.transaction_id %></div>
                  </div>
                <% } %>
                
                <div class="row mb-3">
                  <div class="col-md-4 text-muted">Created At:</div>
                  <div class="col-md-8"><%= formatDateTime(payment.created_at) %></div>
                </div>
                
                <% if (payment.status === 'refunded') { %>
                  <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    This payment has been refunded.
                  </div>
                <% } %>
                
                <% if (canRefund) { %>
                  <div class="mt-4">
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#refundModal">
                      <i class="bi bi-arrow-counterclockwise me-2"></i> Request Refund
                    </button>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
          
          <div class="col-lg-4">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Event Information</h5>
              </div>
              <div class="card-body">
                <h6><%= payment.Ticket.Event.title %></h6>
                <p class="text-muted">
                  <i class="bi bi-calendar-event me-2"></i> <%= formatDate(payment.Ticket.Event.start_date) %>
                </p>
                <p class="text-muted">
                  <i class="bi bi-geo-alt me-2"></i> <%= payment.Ticket.Event.Venue ? payment.Ticket.Event.Venue.name : 'Venue' %>
                </p>
                <div class="d-grid gap-2">
                  <a href="/tickets/view/<%= payment.Ticket.ticket_code %>" class="btn btn-outline-primary">
                    <i class="bi bi-ticket-perforated me-2"></i> View Ticket
                  </a>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Need Help?</h5>
              </div>
              <div class="card-body">
                <p>If you have any questions about this payment, please contact our support team.</p>
                <div class="d-grid gap-2">
                  <a href="mailto:support@example.com" class="btn btn-outline-secondary">
                    <i class="bi bi-envelope me-2"></i> Contact Support
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <%- include('../partials/footer') %>
  
  <!-- Refund Modal -->
  <% if (canRefund) { %>
    <div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="refundModalLabel">Request Refund</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form action="/payments/api/<%= payment.id %>/refund" method="POST" id="refundForm">
            <div class="modal-body">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Are you sure you want to request a refund? This action cannot be undone.
              </div>
              <div class="mb-3">
                <label for="reason" class="form-label">Reason for Refund</label>
                <textarea id="reason" name="reason" class="form-control" rows="3" required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Request Refund</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <% } %>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    <% if (canRefund) { %>
      // Handle refund form submission
      document.getElementById('refundForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const reason = document.getElementById('reason').value.trim();
        
        if (!reason) {
          alert('Please provide a reason for the refund');
          return;
        }
        
        try {
          const response = await fetch(this.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason })
          });
          
          const result = await response.json();
          
          if (response.ok && result.status === 'success') {
            alert('Refund processed successfully');
            window.location.reload();
          } else {
            alert(`Error: ${result.message || 'Failed to process refund'}`);
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
          console.error(error);
        }
      });
    <% } %>
  </script>
</body>
</html>